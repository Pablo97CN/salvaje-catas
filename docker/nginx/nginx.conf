server {
  listen 80;
  server_name _;

  # ---- FRONTEND (Vite dev server detrás de Nginx)
  location / {
    proxy_pass http://frontend:5173;
    proxy_http_version 1.1;

    # WebSocket/HMR
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Encabezados básicos
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_cache_bypass $http_upgrade;
  }

  # (Opcionales) rutas explícitas que usa Vite/HMR
  location ^~ /@vite/ {
    proxy_pass http://frontend:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location ^~ /@react-refresh {
    proxy_pass http://frontend:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location ^~ /node_modules/ {
    proxy_pass http://frontend:5173;
    proxy_http_version 1.1;
  }

  location ^~ /src/ {
    proxy_pass http://frontend:5173;
    proxy_http_version 1.1;
  }

  location = /vite.svg {
    proxy_pass http://frontend:5173;
    proxy_http_version 1.1;
  }

  # ---- BACKEND (Laravel por PHP‑FPM en backend:9000)
  root /var/www/public;
  index index.php;

  # Solo todo lo que empiece por /api -> Laravel (index.php) vía FastCGI
  location ^~ /api/ {
    include       fastcgi_params;
    fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
    fastcgi_param PATH_INFO       $uri;
    fastcgi_param QUERY_STRING    $query_string;
    fastcgi_param REQUEST_METHOD  $request_method;
    fastcgi_param CONTENT_TYPE    $content_type;
    fastcgi_param CONTENT_LENGTH  $content_length;

    fastcgi_pass backend:9000;
  }

  # Bloque PHP genérico: deshabilitado para evitar ejecutar PHP fuera de /api
  location ~ \.php$ {
    return 404;
  }
}


